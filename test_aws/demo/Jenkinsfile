pipeline {
    agent any

    environment {
        EC2_HOST = credentials('ec2-host')
        EC2_USER = 'ec2-user'
        SSH_KEY  = 'ec2-ssh-key'
    }

    triggers {
        githubPush()
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                echo 'Building Docker image...'
                bat 'docker build -t wildlife-gallery ./test_aws/demo'
            }
        }

        stage('Test') {
            steps {
                echo 'No tests configured yet. Add tests here when ready.'
            }
        }

        stage('Deploy to EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY_FILE', usernameVariable: 'SSH_USER')]) {
                    bat 'ssh -o StrictHostKeyChecking=no -p 2222 -i %SSH_KEY_FILE% %EC2_USER%@%EC2_HOST% "cd /opt/wildlife-gallery && git pull origin master && cd test_aws/demo && docker-compose -f docker-compose.prod.yml up -d --build --force-recreate && echo Waiting for services to start... && sleep 15 && curl -f http://localhost/health || echo Health check failed"'
                }
            }
        }
    }

    post {
        success {
            echo "Deployment successful! App is live at http://${EC2_HOST}"
        }
        failure {
            echo 'Pipeline failed. Check the logs above for details.'
        }
    }
}
